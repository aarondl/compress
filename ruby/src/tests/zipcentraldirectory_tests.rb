require 'test/unit'
require_relative '../memoryfile'
require_relative '../zipcentraldirectory'

class TestZipCentralDirectory < Test::Unit::TestCase

	def test_read
		memfile = MemoryFile.new([
			0x50,0x4B,0x01,0x02,0x14,0x00,0x14,0x00,0x00,0x00,0x00,0x00,0x80,
			0x9A,0x8D,0x3E,0xA8,0xCC,0x2B,0x26,0x0E,0x00,0x00,0x00,0x0E,0x00,
			0x00,0x00,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x20,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x74,0x65,0x78,0x74,0x2E,0x74,
			0x78,0x74,0x50,0x4B,0x01,0x02,0x14,0x00,0x14,0x00,0x00,0x00,0x08,
			0x00,0xE4,0xAC,0x8D,0x3E,0x90,0x1E,0x76,0x3D,0x08,0x00,0x00,0x00,
			0x0B,0x00,0x00,0x00,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,
			0x00,0x20,0x00,0x00,0x00,0x34,0x00,0x00,0x00,0x73,0x65,0x63,0x6F,
			0x6E,0x64,0x54,0x65,0x78,0x74,0x46,0x69,0x6C,0x65,0x2E,0x74,0x78,
			0x74
		])

		z = ZipCentralDirectory.new()
		z.read_from_stream(memfile)
		assert(z.is_valid?)

		# Verify all local header information
		assert_equal(20, z.zip_header.version_needed)
		assert_equal(0, z.zip_header.bitflag)
		assert_equal(0, z.zip_header.compression_method)
		assert_equal(39552, z.zip_header.last_modified_time)
		assert_equal(16013, z.zip_header.last_modified_date)
		assert_equal('262bcca8', z.zip_header.zip_descriptor.crc)
		assert_equal(14, z.zip_header.zip_descriptor.compressed_size)
		assert_equal(14, z.zip_header.zip_descriptor.uncompressed_size)
		assert_equal(8, z.zip_header.filename_len)
		assert_equal(0, z.zip_header.extra_field_len)
		assert_equal('text.txt', z.zip_header.filename)
		assert_equal(0, z.zip_header.extra_fields.length)

		# Verify central directory information
		assert_equal(20, z.version_made)
		assert_equal(0, z.comment_len)
		assert_equal(0, z.disk_num)
		assert_equal(1, z.internal_attribs)
		assert_equal(32, z.external_attribs)
		assert_equal(0, z.local_header_offset)
		assert_nil(z.comment)
	end
end